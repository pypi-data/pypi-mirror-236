import{ImageInspectorView}from"../../view/image.mjs";import{isEmpty,isEquivalent,waitFor,humanDuration}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{Controller}from"../base.mjs";const E=new ElementBuilder({invocationTask:"enfugue-invocation-task",invocationLoading:"enfugue-invocation-loading",invocationLoaded:"enfugue-invocation-loaded",invocationDuration:"enfugue-invocation-duration",invocationIterations:"enfugue-invocation-iterations",invocationRemaining:"enfugue-invocation-remaining",invocationSampleChooser:"enfugue-invocation-sample-chooser",invocationSample:"enfugue-invocation-sample",engineStop:"enfugue-engine-stop"});class InvocationController extends Controller{static truncatePromptLength=36;constructor(e){super(e),this.kwargs={}}get width(){return this.kwargs.width||this.application.config.model.invocation.width}set width(e){this.width!==e&&this.publish("engineWidthChange",e),this.kwargs.width=e}get height(){return this.kwargs.height||this.application.config.model.invocation.height}set height(e){this.height!==e&&this.publish("engineHeightChange",e),this.kwargs.height=e}get size(){return this.kwargs.size||512}set size(e){this.size!==e&&this.publish("engineSizeChange",e),this.kwargs.size=e}get chunkingSize(){return this.kwargs.chunking_size||this.application.config.model.invocation.chunkingSize}set chunkingSize(e){this.chunkingSize!==e&&this.publish("engineChunkingSizeChange",e),this.kwargs.chunking_size=e}get chunkingMaskType(){return this.kwargs.chunking_mask_type||null}set chunkingMaskType(e){this.chunkingMaskType!==e&&this.publish("engineChunkingMaskTypeChange",e),this.kwargs.chunking_mask_type=e}get prompt(){return this.kwargs.prompt||""}get prompt2(){return this.kwargs.prompt_2||""}set prompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.prompt!==i&&this.publish("enginePromptChange",i),this.prompt2!==t&&this.publish("enginePrompt2Change",t),this.kwargs.prompt=i,this.kwargs.prompt_2=t}get negativePrompt(){return this.kwargs.negative_prompt||""}get negativePrompt2(){return this.kwargs.negative_prompt_2||""}set negativePrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.negativePrompt!==i&&this.publish("engineNegativePromptChange",i),this.negativePrompt2!==t&&this.publish("engineNegativePrompt2Change",t),this.kwargs.negative_prompt=i,this.kwargs.negative_prompt_2=t}get samples(){return this.kwargs.samples||1}set samples(e){this.samples!==e&&this.publish("engineSamplesChange",e),this.kwargs.samples=e}get iterations(){return this.kwargs.iterations||1}set iterations(e){this.iterations!==e&&this.publish("engineIterationsChange",e),this.kwargs.iterations=e}get seed(){return this.kwargs.seed}set seed(e){this.seed!==e&&this.publish("engineSeedChange",e),this.kwargs.seed=e}get guidanceScale(){return this.kwargs.guidance_scale||this.application.config.model.invocation.guidanceScale}set guidanceScale(e){this.guidanceScale!==e&&this.publish("engineGuidanceScaleChange",e),this.kwargs.guidance_scale=e}get inferenceSteps(){return this.kwargs.num_inference_steps||this.application.config.model.invocation.inferenceSteps}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get model(){return this.kwargs.model}set model(e){this.model!==e&&this.publish("engineModelChange",e),this.kwargs.model=e}get modelType(){return this.kwargs.model_type||"checkpoint"}set modelType(e){this.modelType!==e&&this.publish("engineModelTypeChange",e),this.kwargs.model_type=e}get upscaleSteps(){return this.kwargs.upscale_steps||null}set upscaleSteps(e){let i=[];for(let t of e){let e={};isEmpty(t.prompt)||(Array.isArray(t.prompt)?(e.prompt=t.prompt[0],e.prompt_2=t.prompt[1]):e.prompt=t.prompt),isEmpty(t.negativePrompt)||(Array.isArray(t.negativePrompt)?(e.negative_prompt=t.negativePrompt[0],e.negative_prompt_2=t.negativePrompt[1]):e.negative_prompt=t.negativePrompt);for(let i of["strength","method","amount","scheduler"])isEmpty(t[i])||(e[i]=t[i]);isEmpty(t.inferenceSteps)||(e.num_inference_steps=t.inferenceSteps),isEmpty(t.guidanceScale)||(e.guidance_scale=t.guidanceScale),isEmpty(t.chunkingSize)||(e.chunking_size=t.chunkingSize),isEmpty(t.chunkingMaskType)||(e.chunking_mask_type=t.chunkingMaskType),isEmpty(t.controlnet)||(e.controlnets=[t.controlnet]),isEmpty(t.pipeline)||(e.refiner="base"!==t.pipeline),isEmpty(t.noiseOffset)||(e.noise_offset=t.noiseOffset),isEmpty(t.noiseMethod)||(e.noise_method=t.noiseMethod),isEmpty(t.noiseBlendMethod)||(e.noise_blend_method=t.noiseBlendMethod),i.push(e)}isEquivalent(this.upscaleSteps,i)||this.publish("engineUpscaleStepsChange",i),this.kwargs.upscale_steps=i}get inversion(){return this.kwargs.inversion||[]}set inversion(e){isEquivalent(this.inversion,e)||this.publish("engineInversionChange",e),this.kwargs.inversion=e}get lora(){return this.kwargs.lora||[]}set lora(e){isEquivalent(this.lora,e)||this.publish("engineLoraChange",e),this.kwargs.lora=e}get lycoris(){return this.kwargs.lycoris||[]}set lycoris(e){isEquivalent(this.lycoris,e)||this.publish("engineLycorisChange",e),this.kwargs.lycoris=e}get refiner(){return this.kwargs.refiner||null}set refiner(e){this.refiner!==e&&this.publish("engineRefinerChange",e),this.kwargs.refiner=e}get refinerSize(){return this.kwargs.refiner_size||null}set refinerSize(e){this.refinerSize!==e&&this.publish("engineRefinerSizeChange",e),this.kwargs.refiner_size=e}get refinerVae(){return this.kwargs.refiner_vae||null}set refinerVae(e){this.refinerVae!==e&&this.publish("engineRefinerVaeChange",e),this.kwargs.refiner_vae=e}get refinerPrompt(){return this.kwargs.refiner_prompt||null}get refinerPrompt2(){return this.kwargs.refiner_prompt_2||null}set refinerPrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.refinerPrompt!==i&&this.publish("engineRefinerPromptChange",i),this.refinerPrompt2!==t&&this.publish("engineRefinerPrompt2Change",t),this.kwargs.refiner_prompt=i,this.kwargs.refiner_prompt_2=t}get refinerNegativePrompt(){return this.kwargs.refiner_negative_prompt||null}get refinerNegativePrompt2(){return this.kwargs.refiner_negative_prompt_2||null}set refinerNegativePrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.refinerNegativePrompt!==i&&this.publish("engineRefinerNegativePromptChange",i),this.refinerNegativePrompt2!==t&&this.publish("engineRefinerNegativePrompt2Change",t),this.kwargs.refiner_negative_prompt=i,this.kwargs.refiner_negative_prompt_2=t}get refinerStart(){return this.kwargs.refiner_start||.85}set refinerStart(e){this.refinerStart!==e&&this.publish("engineRefinerStartChange",e),this.kwargs.refiner_start=e}get refinerStrength(){return this.kwargs.refiner_strength||.3}set refinerStrength(e){this.refinerStrength!==e&&this.publish("engineRefinerStrengthChange",e),this.kwargs.refiner_strength=e}get refinerGuidanceScale(){return this.kwargs.refiner_guidance_scale||5}set refinerGuidanceScale(e){this.refinerGuidanceScale!==e&&this.publish("engineRefinerGuidanceScaleChange",e),this.kwargs.refiner_guidance_scale=e}get refinerAestheticScore(){return this.kwargs.refiner_aesthetic_score||6}set refinerAestheticScore(e){this.refinerAestheticScore!==e&&this.publish("engineAestheticScoreChange",e),this.kwargs.refiner_aesthetic_score=e}get refinerNegativeAestheticScore(){return this.kwargs.refiner_negative_aesthetic_score||2.5}set refinerNegativeAestheticScore(e){this.refinerNegativeAestheticScore!==e&&this.publish("engineNegativeAestheticScoreChange",e),this.kwargs.refiner_negative_aesthetic_score=e}get inpainter(){return this.kwargs.inpainter||null}set inpainter(e){this.inpainter!==e&&this.publish("engineInpainterChange",e),this.kwargs.inpainter=e}get inpainterSize(){return this.kwargs.inpainter_size||null}set inpainterSize(e){this.inpainterSize!==e&&this.publish("engineInpainterSizeChange",e),this.kwargs.inpainter_size=e}get inpainterVae(){return this.kwargs.inpainter_vae||null}set inpainterVae(e){this.inpainterVae!==e&&this.publish("engineInpainterVaeChange",e),this.kwargs.inpainter_vae=e}get scheduler(){return this.kwargs.scheduler||null}set scheduler(e){this.scheduler!==e&&this.publish("engineSchedulerChange"),this.kwargs.scheduler=e}get vae(){return this.kwargs.vae||null}set vae(e){this.vae!==e&&this.publish("engineVaeChange"),this.kwargs.vae=e}get clipSkip(){return this.kwargs.clip_skip||null}set clipSkip(e){this.clipSkip!==e&&this.publish("engineClipSkipChange"),this.kwargs.clip_skip=e}get freeUFactors(){return this.kwargs.freeu_factors||null}set freeUFactors(e){isEquivalent(this.freeUFactors,e)||this.publish("engineFreeUFactorsChange"),this.kwargs.freeu_factors=e}get noiseOffset(){return this.kwargs.noise_offset||0}set noiseOffset(e){this.noiseOffset!==e&&this.publish("engineNoiseOffsetChange"),this.kwargs.noise_offset=e}get noiseMethod(){return this.kwargs.noise_method||"perlin"}set noiseMethod(e){this.noiseMethod!==e&&this.publish("engineNoiseMethodChange"),this.kwargs.noise_method=e}get noiseBlendMethod(){return this.kwargs.noise_blend_method||"inject"}set noiseBlendMethod(e){this.noiseBlendMethod!==e&&this.publish("engineNoiseBlendMethodChange"),this.kwargs.noise_blend_method=e}async initialize(){this.loadingBar=E.invocationLoading().content(E.invocationLoaded().addClass("sliding-gradient"),E.invocationDuration(),E.invocationIterations(),E.invocationTask().hide(),E.invocationRemaining().hide()),this.invocationSampleChooser=E.invocationSampleChooser().hide(),this.engineStop=E.engineStop().content("Stop Engine").on("click",(()=>{this.stopEngine()})),(await this.images.getNode()).append(this.loadingBar).append(this.invocationSampleChooser),this.application.container.appendChild(await this.engineStop.render()),this.subscribe("engineReady",(()=>{this.enableStop()})),this.subscribe("engineBusy",(()=>{this.enableStop()})),this.subscribe("engineIdle",(()=>{this.disableStop()}))}hideSampleChooser(){this.invocationSampleChooser.hide()}enableStop(){this.engineStop.addClass("ready")}disableStop(){this.engineStop.removeClass("ready")}async invoke(e,i=!1){e=isEmpty(e)?{}:e;let t={...this.kwargs,...e};for(let e of Object.getOwnPropertyNames(t))"number"==typeof t[e]&&isNaN(t[e])&&delete t[e];this.config.debug&&console.log("Invoking with payload",t);let n=await this.application.model.post("invoke",null,null,t);if(this.enableStop(),!isEmpty(n.uuid))if(i){let e=t.prompt.substring(0,this.constructor.truncatePromptLength);e.length===this.constructor.truncatePromptLength&&(e+="..."),await this.startDetachedInvocationMonitor(e,n.uuid,parseInt(t.width)||512,parseInt(t.height)||512)}else await this.canvasInvocation(n.uuid)}async stopEngine(){if(this.engineStop.hasClass("ready")&&await this.confirm("Stop engine and terminate any active invocations?"))try{await this.application.model.post("/invocation/stop"),this.disableStop(),this.notify("info","Stopped","Successfully stopped engine.")}catch(e){let i=`${e}`;isEmpty(e.detail)?isEmpty(e.title)||(i=e.title):i=e.detail,this.notify("error","Error",`Received an error when stopping. The engine may still be stopped, wait a moment and check again. ${i}`)}}async monitorInvocation(e,i,t,n,s){const a=this.application.config.model.invocation.interval||1e3,r=this.application.config.model.queue.interval||5e3,o=this.application.config.model.invocation.errors.consecutive||2;void 0===t&&(t=()=>{}),void 0===i&&(i=()=>{}),void 0===n&&(n=()=>{}),void 0===s&&(s=()=>{});let h,g,p,l,c,m,u,d=(new Date).getTime(),f=async()=>{let v,w;for(let i=0;i<o;i++)try{v=await this.application.model.get(`/invocation/${e}`)}catch(e){w=e}if(isEmpty(v))return this.notify("error","Invocation Error",`${o} consecutive errors were detected communicating with the server. Please check the server logs. The last error was: ${w}`),void n();if(v.total!==p&&(isEmpty(p)||(d=(new Date).getTime()),p=v.total),v.step!==g&&(g=v.step,m=(new Date).getTime()),v.rate!==l&&(l=v.rate),v.task!==h&&(i(v.task),h=v.task),c=v.duration,!isEmpty(v.images)){let e=v.images.map((e=>`/api/invocation/${e}`)),i="completed"===v.status;t(e,i)}if("error"===v.status)return this.notify("error","Invocation Failed",v.message),void n();if("completed"!==v.status){let e=g/(m-d),i=isEmpty(l)?e:l/1e3,t=(p-g)/(.75*i+.25*e)-((new Date).getTime()-m);isNaN(t)&&(t=1/0),s(t,g,p,l,c),u=setTimeout(f,(e=>"queued"===e.status?r:a)(v))}};f()}setSampleImages(e){let i=this.invocationSampleChooser.children().length;if(isEmpty(e))return this.images.hideCurrentInvocation(),void this.invocationSampleChooser.empty().hide();0===i?(null===this.invocationSampleIndex&&(this.invocationSampleIndex=0),this.invocationSampleChooser.append(E.invocationSample().class("no-sample").content("×").on("click",(()=>{this.invocationSampleIndex=null,this.images.hideCurrentInvocation()})))):i--;for(let t=0;t<e.length;t++){let n=new Image;if(t>=i){n.src=e[t];let i=E.invocationSample().content(n).on("click",(()=>{this.images.setCurrentInvocationImage(e[t]),this.invocationSampleIndex=t}));this.invocationSampleChooser.append(i)}else{let i=this.invocationSampleChooser.getChild(t+1);i.off("click").on("click",(()=>{this.images.setCurrentInvocationImage(e[t]),this.invocationSampleIndex=t})),n.onload=()=>{i.content(n)},n.src=e[t]}}isEmpty(this.invocationSampleIndex)||this.images.setCurrentInvocationImage(e[this.invocationSampleIndex]),this.invocationSampleChooser.show().render()}async canvasInvocation(e){let i,t,n,s,a,r,o,h,g,p,l,c=!1,m=!1,u=(new Date).getTime(),d=u,f=u,v=u,w=this.loadingBar.find(E.getCustomTag("invocationTask")),k=this.loadingBar.find(E.getCustomTag("invocationLoaded")),S=this.loadingBar.find(E.getCustomTag("invocationDuration")),y=this.loadingBar.find(E.getCustomTag("invocationIterations")),_=this.loadingBar.find(E.getCustomTag("invocationRemaining")),C=()=>this.setSampleImages(r),b=()=>{let e=(new Date).getTime();if(m)s<100&&s>0?s+=1:(s=100,c=!0);else if(!isEmpty(t)&&t<1/0){let r=e-f,o=t-(e-n),h=r+o;a=o,i=h,s=r/h*100}d=e,(()=>{let e=d-u;if(S.content(humanDuration(e/1e3)),isEmpty(s))k.css("width","100%"),y.hide(),_.show().content("Initializing…");else if(s<100){_.show().content(humanDuration(a/1e3)),k.css("width",`${s.toFixed(2)}%`);let e=g,i="it/s";!isEmpty(e)&&e<1/0&&0!==e?(e<1&&(e=1/e,i="s/it"),y.show().content(`Iteration ${o}/${h} (${e.toFixed(2)} ${i})`)):y.show().content(`Iteration ${o}/${h}`)}else if(c||isEmpty(p))k.css("width","0"),_.empty().hide();else{_.content("Finalizing step…");let e=h/p,i="it/s";e<1&&(e=1/e,i="s/it"),y.content(`${h} Iterations at ${e.toFixed(2)} ${i}`),k.css("width","100%")}})(),c||requestAnimationFrame((()=>b()))};this.loadingBar.addClass("loading"),this.images.hideCurrentInvocation(),this.invocationSampleChooser.empty(),this.invocationSampleIndex=null,window.requestAnimationFrame((()=>b())),this.monitorInvocation(e,(e=>{l=e,isEmpty(e)?w.empty().hide():w.content(e).show()}),(async(e,i)=>{m=i,e.length>0&&(r=e,C())}),(()=>{m=!0,c=!0,_.empty().hide(),y.empty().hide(),w.empty().hide()}),((e,i,a,r,l)=>{t=e,o!==i&&(v=n),o=i,g=r,p=l,n=(new Date).getTime(),h!==a&&(f=n,isEmpty(h)||(o=0,s=null,v=n)),h=a})),await waitFor((()=>c)),w.empty().hide(),this.loadingBar.removeClass("loading")}async startDetachedInvocationMonitor(e,i,t,n){let s=!1,a=[],r=[];this.monitorInvocation(i,(async(o,h,g)=>{s=!0;for(let s in o){let h=o[s];if(a.length<=s){let o=new ImageInspectorView(this.application.config,h,i),g=await this.spawnWindow(`${e}, sample ${s+1}`,o,t+30,n+90);o.loading(),a.push(g),r.push(o)}else r[s].setImage(h),a[s].setName(`${e}, ${g} elapsed, sample ${s+1}`)}if(h)for(let i in a)a[i].setName(`${e} complete in ${g}, sample ${i+1}`),r[i].doneLoading()}),(()=>s=!0)),await waitFor((()=>!0===s))}getDefaultState(){return{samples:null,sample:null}}getState(e=!0){if(!e)return this.getDefaultState();let i=this.invocationSampleChooser.children();return i.length<2?this.getDefaultState():{sample:this.invocationSampleIndex,samples:i.slice(1).map((e=>e.getChild(0).src))}}setState(e){this.invocationSampleChooser.empty(),isEmpty(e)||isEmpty(e.samples)?(this.invocationSampleIndex=null,this.invocationSampleChooser.hide()):(this.invocationSampleIndex=e.sample,this.setSampleImages(e.samples))}}export{InvocationController};
