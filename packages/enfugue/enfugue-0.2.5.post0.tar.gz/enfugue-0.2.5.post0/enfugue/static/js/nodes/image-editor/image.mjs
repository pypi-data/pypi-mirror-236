import{isEmpty}from"../../base/helpers.mjs";import{View}from"../../view/base.mjs";import{ScribbleView}from"../../view/scribble.mjs";import{ImageView,BackgroundImageView}from"../../view/image.mjs";import{ImageEditorImageNodeOptionsFormView}from"../../forms/enfugue/image-editor.mjs";import{CompoundNodeView}from"../base.mjs";import{ImageEditorNodeView}from"./base.mjs";import{ImageEditorScribbleNodeView}from"./scribble.mjs";class ImageEditorCompoundImageNodeView extends CompoundNodeView{static hideHeader=!0;static snapSize=8;static nodeTypeName="Images";static canFlipHeader=!0;static padding=8;static edgeHandlerTolerance=8;static minHeight=32;static minWidth=32;static closeText="Remove";static passThroughMethods=["clearMemory","increaseSize","decreaseSize","togglePencilShape","toggleEraser","rotateClockwise","rotateCounterClockwise","mirrorHorizontally","mirrorVertically","toggleOptions"];constructor(t,e,i,o,r,s,a,n){super(t,e,i,o,r,s,a,n);for(let t of this.constructor.passThroughMethods)this[t]=function(){return this.content.selectedNode[t].apply(this.content.selectedNode,Array.from(arguments))}}}class ImageScribbleView extends View{static tagName="enfugue-image-scribble-view";constructor(t,e,i,o){super(t),this.src=e,isEmpty(e)||(this.image=new BackgroundImageView(t,e)),this.scribble=new ScribbleView(t,i,o),this.clearScribble()}get isEraser(){return this.scribble.isEraser}set isEraser(t){this.scribble.isEraser=t}get shape(){return this.scribble.shape}set shape(t){this.scribble.shape=t}setScribble(t,e,i){this.scribble.setMemory(t),this.scribble.resizeCanvas(e,i),this.scribble.show()}clearScribble(){this.scribble.clearMemory(),this.scribble.hide()}clearMemory(){this.scribble.clearMemory()}increaseSize(){this.scribble.increaseSize()}decreaseSize(){this.scribble.decreaseSize()}showScribble(){this.scribble.show()}resize(t,e){this.scribble.resizeCanvas(t,e)}get scribbleSrc(){return this.scribble.src}get imageSrc(){return isEmpty(this.image)?this.src:this.image.src}mirrorHorizontally(){if(!isEmpty(this.image))return this.image.mirrorHorizontally()}mirrorVertically(){if(!isEmpty(this.image))return this.image.mirrorVertically()}rotateClockwise(){if(!isEmpty(this.image))return this.image.rotateClockwise()}rotateCounterClockwise(){if(!isEmpty(this.image))return this.image.rotateCounterClockwise()}addImageClass(t){isEmpty(this.image)||this.image.addClass(t)}removeImageClass(t){isEmpty(this.image)||this.image.removeClass(t)}async build(){let t=await super.build();return t.content(await this.scribble.getNode()),isEmpty(this.image)||t.append(await this.image.getNode()),t}}class ImageEditorImageNodeView extends ImageEditorNodeView{static hideHeader=!0;static canMerge=!0;static compoundNodeClass=ImageEditorCompoundImageNodeView;static nodeTypeName="Image";static allFitModes=["actual","stretch","cover","contain"];static allAnchorModes=["top-left","top-center","top-right","center-left","center-center","center-right","bottom-left","bottom-center","bottom-right"];static scribbleButtons=["erase","shape","clear","increase","decrease"];static className="image-editor-image-node-view";static nodeButtons={...ImageEditorNodeView.nodeButtons,shape:{disabled:!0,...ImageEditorScribbleNodeView.nodeButtons.shape},erase:{disabled:!0,...ImageEditorScribbleNodeView.nodeButtons.erase},clear:{disabled:!0,...ImageEditorScribbleNodeView.nodeButtons.clear},increase:{disabled:!0,...ImageEditorScribbleNodeView.nodeButtons.increase},decrease:{disabled:!0,...ImageEditorScribbleNodeView.nodeButtons.decrease},"mirror-x":{icon:"fa-solid fa-left-right",tooltip:"Mirror Horizontally",shortcut:"z",callback:function(){this.mirrorHorizontally()}},"mirror-y":{icon:"fa-solid fa-up-down",tooltip:"Mirror Vertically",shortcut:"y",callback:function(){this.mirrorVertically()}},"rotate-clockwise":{icon:"fa-solid fa-rotate-right",tooltip:"Rotate Clockwise",shortcut:"r",callback:function(){this.rotateClockwise()}},"rotate-counter-clockwise":{icon:"fa-solid fa-rotate-left",tooltip:"Rotate Counter-Clockwise",shortcut:"w",callback:function(){this.rotateCounterClockwise()}}};static optionsFormView=ImageEditorImageNodeOptionsFormView;constructor(t,e,i,o,r,s,a){super(t,e,new ImageScribbleView(t.config,isEmpty(i)?null:i.src,s,a),o,r,s,a)}async resized(){await super.resized(),this.content.resize(this.visibleWidth-2*this.constructor.padding,this.visibleHeight-2*this.constructor.padding)}clearMemory(){this.content.clearMemory()}increaseSize(){this.content.increaseSize()}decreaseSize(){this.content.decreaseSize()}async updateOptions(t){if(super.updateOptions(t),this.updateFit(t.fit),this.updateAnchor(t.anchor),this.infer=t.infer,this.control=t.control,this.inpaint=t.inpaint,this.imagePrompt=t.imagePrompt,this.strength=t.strength,this.imagePromptScale=t.imagePromptScale,this.imagePromptPlus=t.imagePromptPlus,this.imagePromptFace=t.imagePromptFace,this.controlnet=t.controlnet,this.conditioningScale=t.conditioningScale,this.conditioningStart=t.conditioningStart,this.conditioningEnd=t.conditioningEnd,this.processControlImage=t.processControlImage,this.invertControlImage=t.invertControlImage,this.cropInpaint=t.cropInpaint,this.inpaintFeather=t.inpaintFeather,void 0!==this.node&&(this.inpaint?(this.content.showScribble(),this.content.resize(this.w,this.h)):this.content.clearScribble()),!isEmpty(this.buttons))for(let e of this.constructor.scribbleButtons)this.buttons[e].disabled=!t.inpaint;this.rebuildHeaderButtons()}async updateFit(t){this.fit=t,this.content.fit=t;for(let t of this.constructor.allFitModes)this.content.removeImageClass(`fit-${t}`);isEmpty(t)||this.content.addImageClass(`fit-${t}`)}async updateAnchor(t){this.anchor=t,this.content.anchor=t;for(let t of this.constructor.allAnchorModes)this.content.removeImageClass(`anchor-${t}`);isEmpty(t)||this.content.addImageClass(`anchor-${t}`)}mirrorHorizontally(){return this.content.mirrorHorizontally()}mirrorVertically(){return this.content.mirrorVertically()}rotateClockwise(){return this.content.rotateClockwise()}rotateCounterClockwise(){return this.content.rotateCounterClockwise()}togglePencilShape(){"circle"===this.content.shape?(this.content.shape="square",this.buttons.shape.tooltip=ImageEditorScribbleNodeView.pencilCircleTooltip,this.buttons.shape.icon=ImageEditorScribbleNodeView.pencilCircleIcon):(this.content.shape="circle",this.buttons.shape.tooltip=ImageEditorScribbleNodeView.pencilSquareTooltip,this.buttons.shape.icon=ImageEditorScribbleNodeView.pencilSquareIcon),this.rebuildHeaderButtons()}toggleEraser(){!0===this.content.isEraser?(this.content.isEraser=!1,this.buttons.erase.icon=ImageEditorScribbleNodeView.eraserIcon,this.buttons.erase.tooltip=ImageEditorScribbleNodeView.eraserTooltip):(this.content.isEraser=!0,this.buttons.erase.icon=ImageEditorScribbleNodeView.pencilIcon,this.buttons.erase.tooltip=ImageEditorScribbleNodeView.pencilTooltip),this.rebuildHeaderButtons()}getState(t=!0){let e=super.getState(t);return e.scribbleSrc=t?this.content.scribbleSrc:null,e.src=t?this.content.imageSrc:null,e.anchor=this.anchor||null,e.fit=this.fit||null,e.infer=this.infer||!1,e.control=this.control||!1,e.inpaint=this.inpaint||!1,e.imagePrompt=this.imagePrompt||!1,e.imagePromptPlus=this.imagePromptPlus||!1,e.imagePromptFace=this.imagePromptFace||!1,e.imagePromptScale=this.imagePromptScale||.5,e.strength=this.strength||.8,e.controlnet=this.controlnet||null,e.cropInpaint=!1!==this.cropInpaint,e.inpaintFeather=this.inpaintFeather||32,e.conditioningScale=this.conditioningScale||1,e.conditioningStart=this.conditioningStart||0,e.conditioningEnd=this.conditioningEnd||1,e.processControlImage=!1!==this.processControlImage,e.invertControlImage=!0===this.invertControlImage,e.removeBackground=!0===this.removeBackground,e.scaleToModelSize=!0===this.scaleToModelSize,e}async setState(t){if(await super.setState(t),await this.setContent(new ImageScribbleView(this.config,t.src,t.w,t.h)),await this.updateAnchor(t.anchor),await this.updateFit(t.fit),t.inpaint){let e=new Image;e.onload=()=>{this.content.setScribble(e,this.w,this.h)},e.src=t.scribbleSrc}else this.content.clearScribble();if(!isEmpty(this.buttons))for(let e of this.constructor.scribbleButtons)this.buttons[e].disabled=!t.inpaint;this.rebuildHeaderButtons()}static getDefaultState(){return{classname:this.name,inpaint:!1,control:!1,inpaint:!1,imagePrompt:!1,imagePromptPlus:!1,imagePromptFace:!1,cropInpaint:!0,inpaintFeather:32,inferenceSteps:null,guidanceScale:null,imagePromptScale:.5,strength:.8,processControlImage:!0,invertControlImage:!1,conditioningScale:1,conditioningStart:0,conditioningEnd:1,removeBackground:!1,scaleToModelSize:!1}}async build(){let t=await super.build();if(!0===this.inpaint){for(let t of this.constructor.scribbleButtons)this.buttons[t].disabled=!1;setTimeout((()=>this.rebuildHeaderButtons()),250)}return t}}export{ImageEditorImageNodeView,ImageEditorCompoundImageNodeView};
