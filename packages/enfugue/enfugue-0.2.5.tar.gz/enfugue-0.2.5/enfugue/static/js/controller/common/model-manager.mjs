import{isEmpty,deepClone}from"../../base/helpers.mjs";import{Controller}from"../base.mjs";import{ParentView}from"../../view/base.mjs";import{TableView,ModelTableView}from"../../view/table.mjs";import{ButtonInputView}from"../../forms/input.mjs";import{ModelFormView}from"../../forms/enfugue/models.mjs";class NewModelInputView extends ButtonInputView{static defaultValue="New Model Configuration";static className="new-model-input-view"}class ModelManagerController extends Controller{static modelWindowWidth=400;static modelWindowHeight=1e3;static managerWindowWidth=800;static managerWindowHeight=600;async createManager(){this.tableView=new ModelTableView(this.config,this.model.DiffusionModel),this.buttonView=new NewModelInputView(this.config),this.tableView.setColumns({name:"Name",model:"Model",size:"Size",prompt:"Prompt",negative_prompt:"Negative Prompt"}),this.tableView.setSearchFields(["name","prompt","negative_prompt","model"]),this.tableView.setFormatter("size",(e=>`${e}px`)),this.tableView.addButton("Edit","fa-solid fa-edit",(async e=>{let i=e.getAttributes();if(i.checkpoint=i.model,i.lora=isEmpty(e.lora)?[]:e.lora.map((e=>e.getAttributes())),i.lycoris=isEmpty(e.lycoris)?[]:e.lycoris.map((e=>e.getAttributes())),i.inversion=isEmpty(e.inversion)?[]:e.inversion.map((e=>e.model)),i.vae=isEmpty(e.vae)?null:e.vae[0].name,isEmpty(e.refiner)||(i.refiner=e.refiner[0].model,i.refiner_size=e.refiner[0].size),isEmpty(e.inpainter)||(i.inpainter=e.inpainter[0].model,i.inpainter_size=e.inpainter[0].size),!isEmpty(e.config)){let t={};for(let i of e.config)t[i.configuration_key]=i.configuration_value;i={...i,...t},isEmpty(t.prompt_2)||(i.prompt=[i.prompt,t.prompt_2]),isEmpty(t.negative_prompt_2)||(i.negative_prompt=[t.negative_prompt,t.negative_prompt_2]),isEmpty(t.upscale_diffusion_prompt_2)||(i.upscale_diffusion_prompt=t.upscale_diffusion_prompt.map(((e,i)=>[e,t.upscale_diffusion_prompt_2[i]]))),isEmpty(t.upscale_diffusion_negative_prompt_2)||(i.upscale_diffusion_negative_prompt=t.upscale_diffusion_negative_prompt.map(((e,i)=>[e,t.upscale_diffusion_negative_prompt_2[i]])))}isEmpty(e.scheduler)||(i.scheduler=e.scheduler[0].name);let t,o=new ModelFormView(this.config,deepClone(i));o.onChange((async e=>{isEmpty(o.values.refiner)?o.removeClass("show-refiner"):o.addClass("show-refiner"),isEmpty(o.values.inpainter)?o.removeClass("show-inpainter"):o.addClass("show-inpainter")})),o.onSubmit((async i=>{Array.isArray(i.prompt)&&(i.prompt_2=i.prompt[1],i.prompt=i.prompt[0]),Array.isArray(i.negative_prompt)&&(i.negative_prompt_2=i.negative_prompt[1],i.negative_prompt=i.negative_prompt[0]);let s=[],n=[],r=[],a=[];if(!isEmpty(i.upscale_diffusion_prompt))for(let e of i.upscale_diffusion_prompt)Array.isArray(e)?(s.push(e[0]),n.push(e[1])):(s.push(e),n.push(null));if(!isEmpty(i.upscale_diffusion_negative_prompt))for(let e of i.upscale_diffusion_negative_prompt)Array.isArray(e)?(r.push(e[0]),a.push(e[1])):(r.push(e),a.push(null));i.upscale_diffusion_prompt=s,i.upscale_diffusion_prompt_2=n,i.upscale_diffusion_negative_prompt=r,i.upscale_diffusion_negative_prompt_2=a;try{await this.model.patch(`/models/${e.name}`,null,null,i),isEmpty(t)||t.remove(),this.tableView.requery()}catch(e){let i=isEmpty(e)?"Couldn't communicate with server.":isEmpty(e.detail)?`${e}`:e.detail;this.notify("error","Couldn't update model",i),o.enable()}})),o.onCancel((()=>t.remove())),t=await this.spawnWindow(`Edit ${e.name}`,o,this.constructor.modelWindowWidth,this.constructor.modelWindowHeight)})),this.tableView.addButton("Delete","fa-solid fa-trash",(async e=>{try{await this.model.delete(`/models/${e.name}`),this.tableView.requery()}catch(e){let i=isEmpty(e)?"Couldn't communicate with server.":isEmpty(e.detail)?`${e}`:e.detail;this.notify("error","Couldn't delete model",i),modelForm.enable()}})),this.buttonView.onChange((()=>{this.showNewModel()}));let e=new ParentView(this.config);return e.addChild(this.tableView),e.addChild(this.buttonView),e}async createModelForm(){let e=new ModelFormView(this.config);return e.onSubmit((async i=>{Array.isArray(i.prompt)&&(i.prompt_2=i.prompt[1],i.prompt=i.prompt[0]),Array.isArray(i.negative_prompt)&&(i.negative_prompt_2=i.negative_prompt[1],i.negative_prompt=i.negative_prompt[0]);let t=[],o=[],s=[],n=[];if(!isEmpty(i.upscale_diffusion_prompt))for(let e of i.upscale_diffusion_prompt)Array.isArray(e)?(t.push(e[0]),o.push(e[1])):(t.push(e),o.push(null));if(!isEmpty(i.upscale_diffusion_negative_prompt))for(let e of i.upscale_diffusion_negative_prompt)Array.isArray(e)?(s.push(e[0]),n.push(e[1])):(s.push(e),n.push(null));i.upscale_diffusion_prompt=t,i.upscale_diffusion_prompt_2=o,i.upscale_diffusion_negative_prompt=s,i.upscale_diffusion_negative_prompt_2=n;try{await this.model.post("/models",null,null,i);isEmpty(this.newModelWindow)||(this.newModelWindow.remove(),this.newModelWindow=null),isEmpty(this.managerWindow)||isEmpty(this.tableView)||this.tableView.requery()}catch(i){let t=isEmpty(i)?"Couldn't communicate with server.":isEmpty(i.detail)?`${i}`:i.detail;this.notify("Error","Couldn't create model",t),e.enable()}})),e.onChange((async i=>{isEmpty(e.values.refiner)?e.removeClass("show-refiner"):e.addClass("show-refiner"),isEmpty(e.values.inpainter)?e.removeClass("show-inpainter"):e.addClass("show-inpainter")})),e.onCancel((()=>{this.newModelWindow.remove(),this.newModelWindow=null})),e}async showNewModel(){isEmpty(this.newModelWindow)?(this.newModelWindow=await this.spawnWindow("New Configuration",this.createModelForm(),this.constructor.modelWindowWidth,this.constructor.modelWindowHeight),this.newModelWindow.onClose((()=>{delete this.newModelWindow}))):this.newModelWindow.focus()}async showManager(){isEmpty(this.managerWindow)?(this.managerWindow=await this.spawnWindow("Model Configuration Manager",this.createManager(),this.constructor.managerWindowWidth,this.constructor.managerWindowHeight),this.managerWindow.onClose((()=>{delete this.managerWindow}))):this.managerWindow.focus()}}export{ModelManagerController};
