import{isEmpty,deepClone,sleep}from"../base/helpers.mjs";import{View}from"../view/base.mjs";import{FormView}from"../forms/base.mjs";import{InputView}from"../forms/input.mjs";import{ElementBuilder}from"../base/builder.mjs";import{NodeEditorDecorationsView,NodeConnectionSpline}from"./decorations.mjs";import{NodeView,OptionsNodeView,CompoundNodeView}from"./base.mjs";const E=new ElementBuilder({node:"enfugue-node",nodeCanvas:"enfugue-node-canvas",editorPosition:"enfugue-node-editor-position",positionReadout:"enfugue-node-editor-position-readout",positionReset:"enfugue-node-editor-position-reset",editorZoom:"enfugue-node-editor-zoom",zoomIn:"enfugue-node-editor-zoom-in",zoomOut:"enfugue-node-editor-zoom-out",zoomReadout:"enfugue-node-editor-zoom-readout",zoomReset:"enfugue-node-editor-zoom-reset"});class NodeEditorView extends View{static tagName="enfugue-node-editor";static canvasWidth="auto";static canvasHeight="auto";static maximumZoom=2;static minimumZoom=.125;static zoomPerScroll=.125;static canMove=!0;static canZoom=!0;static centered=!1;static defaultCursor="default";static disableCursor=!1;static nodeClasses=[NodeView,OptionsNodeView,CompoundNodeView];static classList=["loader-cover"];static zoomInIcon="fa-solid fa-magnifying-glass-plus";static zoomOutIcon="fa-solid fa-magnifying-glass-minus";constructor(t,e,o){super(t),this.zoom=1,this.constructor.centered?("auto"!=this.constructor.canvasWidth&&(this.left=-this.constructor.canvasWidth/2,isEmpty(e)||(this.left+=e/2)),"auto"!=this.constructor.canvasHeight&&(this.top=-this.constructor.canvasHeight/2,isEmpty(o)||(this.top+=o/2))):(this.left=0,this.top=0),this.nodes=[],this.nodeClasses=[].concat(this.constructor.nodeClasses),this.decorations=new NodeEditorDecorationsView(t,this,this.constructor.canvasWidth,this.constructor.canvasHeight),this.resizeCallbacks=[],window.addEventListener("resize",(t=>this.windowResized(t)))}onWindowResize(t){this.resizeCallbacks.push(t)}async windowResized(){if(void 0!==this.node&&!isEmpty(this.node.element)){let[t,e]=[this.node.element.parentElement.clientWidth,this.node.element.parentElement.clientHeight];t<this.width?this.node.addClass("oversize-x"):this.node.removeClass("oversize-x"),e<this.height?this.node.addClass("oversize-y"):this.node.removeClass("oversize-y")}for(let t of this.resizeCallbacks)t()}addNodeClass(t){-1===this.nodeClasses.map((t=>t.name)).indexOf(t.name)&&this.nodeClasses.push(t)}get height(){return"auto"==this.constructor.canvasHeight?void 0!==this.node?this.node.element.clientHeight:0:void 0===this.canvasHeight?this.constructor.canvasHeight:this.canvasHeight}get width(){return"auto"==this.constructor.canvasWidth?void 0!==this.node?this.node.element.clientWidth:0:void 0===this.canvasWidth?this.constructor.canvasWidth:this.canvasWidth}set height(t){if(this.canvasHeight=t,void 0!==this.node){this.node.find(E.getCustomTag("nodeCanvas")).height(t).css("height",`${t}px`),this.decorations.setDimension(this.width,t);for(let t of this.nodes)t.resetDimension()}}set width(t){if(this.canvasWidth=t,void 0!==this.node){this.node.find(E.getCustomTag("nodeCanvas")).width(t).css("width",`${t}px`),this.decorations.setDimension(t,this.height);for(let t of this.nodes)t.resetDimension()}}setDimension(t,e,o=!0){if(isEmpty(t)&&(t=this.canvasWidth),isEmpty(e)&&(e=this.canvasHeight),this.canvasWidth=t,this.canvasHeight=e,void 0!==this.node){if(this.node.find(E.getCustomTag("nodeCanvas")).width(t).height(e).css({width:`${t}px`,height:`${e}px`}),this.decorations.setDimension(t,e),o)for(let t of this.nodes)t.resetDimension()}}getState(){return this.nodes.map((t=>t.getState.apply(t,Array.from(arguments))))}nodeMoved(t){let e;for(let o of this.nodes){if(o.removeClass("merge-source"),o.removeClass("merge-target"),o==t||!o.canMergeWith(t)||t.visibleLeft>=o.visibleRight||t.visibleRight<=o.visibleLeft||t.visibleTop>=o.visibleTop+o.visibleHeight||t.visibleTop+t.visibleHeight<=o.visibleTop)continue;if(Math.abs(t.visibleTop-o.visibleTop)>t.constructor.headerHeight/2)continue;let s=Math.max(t.visibleLeft,o.visibleLeft),i=Math.max(t.visibleTop,o.visibleTop);(Math.min(t.visibleLeft+t.visibleWidth,o.visibleLeft+o.visibleWidth)-s)*(Math.min(t.visibleTop+t.visibleHeight,o.visibleTop+o.visibleHeight)-i)/(t.visibleWidth*t.visibleHeight)>=.33&&(e=o)}isEmpty(e)||(t.addClass("merge-source"),e.addClass("merge-target"))}nodePlaced(t){let e,o;this.nodeMoved(t);for(let t of this.nodes)t.hasClass("merge-source")&&(e=t),t.hasClass("merge-target")&&(o=t);isEmpty(e)||isEmpty(o)||this.mergeNodes(e,o)}mergeNodes(t,e){t.removeClass("merge-source"),e.removeClass("merge-target");try{let o=t.mergeWith(e);this.removeNode(t),this.removeNode(e),this.addNode(o)}catch(t){console.log("Experienced error merging nodes, ignoring",t)}}getNodeClass(t){let e=this.nodeClasses.filter((e=>e.name===t)).shift();if(void 0===e)throw`Class name out of scope: ${t}`;return e}async setState(t){for(let t of this.nodes)this.removeNode(t);let e=this.node.find(E.getCustomTag("nodeCanvas"));for(let o of t){let t=new(this.getNodeClass(o.classname))(this);this.nodes.push(t),await t.setState(o),e.append(await t.getNode())}this.nodes=this.nodes.map(((t,e)=>(t.index=e,t))),await this.redraw()}redraw(){return isEmpty(this.redrawPromise)&&(this.redrawPromise=new Promise((async(t,e)=>{for(let t of this.nodes)await t.resetDimension();window.requestAnimationFrame((()=>{this.decorations.draw(),this.redrawPromise=null,t()}))}))),this.redrawPromise}async addNode(t){let e;"function"==typeof t?e=new t(this,...Array.from(arguments).slice(1)):(e=t,t.editor=this);let o=e.canMerge;if(e.canMerge=!1,this.nodes.push(e),this.nodes=this.nodes.map(((t,e)=>(t.index=e,t))),void 0!==this.node){let t=await e.getNode();this.node.find(E.getCustomTag("nodeCanvas")).append(t)}return e.canMerge=o,e}removeNode(t){for(let e of this.nodes)if(e==t)return this.nodes=this.nodes.filter((e=>e!=t)).map(((t,e)=>(t.index=e,t))),void(isEmpty(this.node)||this.node.find(E.getCustomTag("nodeCanvas")).remove(e.node));throw"Could not find node to remove."}focusNode(t){let e=this.nodes.indexOf(t);e!==this.nodes.length-1&&-1!==e&&(this.nodes=this.nodes.slice(0,e).concat(this.nodes.slice(e+1)),this.nodes.push(t),this.node.find(E.getCustomTag("nodeCanvas")).remove(t.node).append(t.node))}async copyNode(t){let e=t.getState(),o=await this.addNode(t.constructor);return e.x+=t.constructor.padding,e.y+=t.constructor.padding,await o.setState(e),this.focusNode(o),o}async build(){let t=await super.build(),e=E.nodeCanvas().css("cursor",this.constructor.defaultCursor),o=E.positionReadout().content("0,0"),s=E.positionReset().content("Reset"),i=E.editorPosition().content(o,s),n=E.zoomReadout().content(`${this.zoom.toFixed(3)}`),a=E.zoomReset().content("Reset"),r=E.zoomIn().content(E.i().class(this.constructor.zoomInIcon)),h=E.zoomOut().content(E.i().class(this.constructor.zoomOutIcon)),d=E.editorZoom().content(r,h,a,n);"auto"==this.constructor.canvasWidth?e.css("width","100%"):e.width(this.width).css("width",`${this.width}px`),"auto"==this.constructor.canvasHeight?e.css("height","100%"):e.height(this.height).css("height",`${this.height}px`),e.css("left",`${this.left}px`),e.css("top",`${this.top}px`),this.decorations.setDimension(this.width,this.height),e.append(await this.decorations.getNode());for(let t of this.nodes)e.append(await t.getNode());if(window.innerWidth<this.width&&t.addClass("oversize-x"),window.innerHeight<this.height&&t.addClass("oversize-y"),t.append(e),this.constructor.disableCursor)t.css("pointer-events","none");else if(this.constructor.canMove&&(t.append(i),e.on("mousedown",(s=>{if(!(2===s.which||1===s.which&&(s.ctrlKey||s.altKey||s.metaKey)))return;s.preventDefault(),s.stopPropagation();let[i,n]=[s.clientX,s.clientY];e.css("cursor","grabbing"),e.on("mousemove",(s=>{s.preventDefault(),s.stopPropagation();let a,r,[h,d]=[s.clientX-i,s.clientY-n],[c,l]=[this.left+h,this.top+d];if(e.css({left:`${c}px`,top:`${l}px`}),this.constructor.centered){let e=this.constructor.canvasWidth/2-t.element.clientWidth/2,o=this.constructor.canvasHeight/2-t.element.clientHeight/2;a=-e-c/this.zoom,r=-o-l/this.zoom}else a=-c/this.zoom,r=-l/this.zoom;1!=this.zoom&&(a=a.toFixed(2),r=r.toFixed(2)),o.content(`${a},${r}`)})).on("mouseup,mouseleave",(s=>{s.preventDefault(),s.stopPropagation();let a,r,[h,d]=[s.clientX-i,s.clientY-n];if(this.left+=h,this.top+=d,e.off("mouseup,mousemove,mouseleave"),e.css({left:`${this.left}px`,top:`${this.top}px`,cursor:this.constructor.defaultCursor}),this.constructor.centered){let e=this.constructor.canvasWidth/2-t.element.clientWidth/2,o=this.constructor.canvasHeight/2-t.element.clientHeight/2;a=-e-this.left/this.zoom,r=-o-this.top/this.zoom}else a=-this.left/this.zoom,r=-this.top/this.zoom;1!=this.zoom&&(a=a.toFixed(2),r=r.toFixed(2)),o.content(`${a},${r}`)}))})),s.on("click",(s=>{s.preventDefault(),s.stopPropagation(),this.constructor.centered?(this.left=-this.constructor.canvasWidth/2*this.zoom+t.element.clientWidth/2,this.top=-this.constructor.canvasHeight/2*this.zoom+t.element.clientHeight/2):(this.left=0,this.top=0),o.content("0,0"),e.css({left:`${this.left}px`,top:`${this.top}px`})}))),this.constructor.canZoom){t.append(d);let i=(s,i,a)=>{let r=s-this.zoom,h=-i*r,d=-a*r;if(this.left+=h,this.top+=d,this.zoom=s,n.content(this.zoom.toFixed(3)),e.css({left:`${this.left}px`,top:`${this.top}px`,transform:`scale(${this.zoom})`}),this.constructor.canMove){let e,s;if(this.constructor.centered){let o=this.constructor.canvasWidth/2-t.element.clientWidth/2,i=this.constructor.canvasHeight/2-t.element.clientHeight/2;e=-o-this.left/this.zoom,s=-i-this.top/this.zoom}else e=-this.left/this.zoom,s=-this.top/this.zoom;1!=this.zoom&&(e=e.toFixed(2),s=s.toFixed(2)),o.content(`${e},${s}`)}this.zoom>1?t.addClass("zoom-in"):t.removeClass("zoom-in"),this.zoom<1?t.addClass("zoom-out"):t.removeClass("zoom-out")};e.on("wheel",(t=>{if("ENFUGUE-NODE-CANVAS"!==t.target.tagName){let e=t.deltaY>0,o=t.target;for(;null!=o&&"ENFUGUE-NODE-EDITOR"!==o.tagName&&"ENFUGUE-NODE-CANVAS"!==o.tagName;){if(o.scrollHeight!==o.offsetHeight&&"ENFUGUE-NODE-CONTENTS"!==o.tagName){let t=o.offsetHeight+o.scrollTop,s=getComputedStyle(o).overflowY;if(-1!==["auto","scroll"].indexOf(s)){if(o.scrollHeight-t>1&&e)return;if(o.scrollTop>0&&!e)return}}o=o.parentElement}}t.preventDefault(),t.stopPropagation();let e,o=1;this.zoom>=5?o=4:this.zoom>=2.5&&(o=2),e=t.deltaY<0?this.zoom+this.constructor.zoomPerScroll*o:this.zoom-this.constructor.zoomPerScroll*o;let s=t.target,n=t.offsetX,a=t.offsetY;for(;"ENFUGUE-NODE-CANVAS"!=s.tagName&&"ENFUGUE-NODE-EDITOR-CANVAS"!=s.tagName;)n+=s.offsetLeft,a+=s.offsetTop,s=s.parentElement;e>=this.constructor.minimumZoom&&e<=this.constructor.maximumZoom&&e!=this.zoom&&i(e,n,a)})),r.on("click",(t=>{t.preventDefault(),t.stopPropagation();let e=this.zoom+this.constructor.zoomPerScroll;e>=this.constructor.minimumZoom&&e<=this.constructor.maximumZoom&&e!=this.zoom&&i(e,this.width/2,this.height/2)})).on("dblclick",(t=>{t.preventDefault()})),h.on("click",(t=>{t.preventDefault(),t.stopPropagation();let e=this.zoom-this.constructor.zoomPerScroll;e>=this.constructor.minimumZoom&&e<=this.constructor.maximumZoom&&e!=this.zoom&&i(e,this.width/2,this.height/2)})).on("dblclick",(t=>{t.preventDefault()})),a.on("click",(t=>{t.preventDefault(),t.stopPropagation(),this.zoom=1,n.content("1.000"),e.css({transform:"scale(1)"}),s.trigger("click")}))}return t}}class NodesView extends NodeEditorView{static tagName="enfugue-nodes";static canMove=!1;static canZoom=!1}export{NodeEditorView,NodesView};
