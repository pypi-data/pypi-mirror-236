"use strict";(self.webpackChunk_jupyter_collaboration_extension=self.webpackChunk_jupyter_collaboration_extension||[]).push([[719,227,849],{9849:(e,s,t)=>{t.d(s,{b:()=>i});var o=t(9600);const i=e=>o.UI(e,((e,s)=>`${encodeURIComponent(s)}=${encodeURIComponent(e)}`)).join("&")},1227:(e,s,t)=>{t.r(s),t.d(s,{ICollaborativeDrive:()=>m,WebSocketAwarenessProvider:()=>c,WebSocketProvider:()=>y,YDrive:()=>v});var o,i,r=t(4901),n=t(2256),a=t(9476),h=t(7099);!function(e){e[e.ROOM=124]="ROOM",e[e.CHAT=125]="CHAT"}(o||(o={})),function(e){e[e.RELOAD=0]="RELOAD",e[e.OVERWRITE=1]="OVERWRITE",e[e.FILE_CHANGED=2]="FILE_CHANGED",e[e.FILE_OVERWRITTEN=3]="FILE_OVERWRITTEN",e[e.DOC_OVERWRITTEN=4]="DOC_OVERWRITTEN",e[e.SESSION_TOKEN=5]="SESSION_TOKEN"}(i||(i={}));class c extends h.WebsocketProvider{constructor(e){super(e.url,e.roomID,e.awareness.doc,{awareness:e.awareness}),this._isDisposed=!1,this._awareness=e.awareness,this._user=e.user,this._user.ready.then((()=>this._onUserChanged(this._user))).catch((e=>console.error(e))),this._user.userChanged.connect(this._onUserChanged,this),this._messageStream=new r.Stream(this),this.messageHandlers[o.CHAT]=(e,s,t,o,i)=>{const r=n.kf(s),a=JSON.parse(r);this._messageStream.emit(a)}}get isDisposed(){return this._isDisposed}get messageStream(){return this._messageStream}dispose(){this._isDisposed||(this._user.userChanged.disconnect(this._onUserChanged,this),this._isDisposed=!0,this.destroy())}sendMessage(e){const s={type:"text",body:e},t=a.Mf();a.uE(t,o.CHAT),a.uw(t,JSON.stringify(s)),this.ws.send(a._f(t))}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}var d=t(4614),_=t(4788),l=t(2861),u=t(7930),p=t(9849);class y{constructor(e){this._onConnectionClosed=e=>{e.code>=4e3&&e.code<4005&&(console.error("Document provider closed:",e.code,e.reason),(0,l.showErrorMessage)(this._trans.__("Document error"),e.reason,[l.Dialog.okButton()]),this._sharedModel.dispose())},this._onSync=e=>{var s;e&&(this._ready.resolve(),null===(s=this._yWebsocketProvider)||void 0===s||s.off("sync",this._onSync))},this._dialog=null,this._ready=new u.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._session=null,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const s=e.user;s.ready.then((()=>{this._onUserChanged(s)})).catch((e=>console.error(e))),s.userChanged.connect(this._onUserChanged,this),this._connect().catch((e=>console.warn(e)))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}dispose(){var e,s,t;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(s=this._yWebsocketProvider)||void 0===s||s.off("sync",this._onSync),null===(t=this._yWebsocketProvider)||void 0===t||t.destroy(),r.Signal.clearData(this))}async _connect(){this._session=await async function(e,s,t){const o=_.ServerConnection.makeSettings(),i=d.URLExt.join(o.baseUrl,"api/collaboration/session",encodeURIComponent(t)),r={method:"PUT",body:JSON.stringify({format:e,type:s})};let n;try{n=await _.ServerConnection.makeRequest(i,r,o)}catch(e){throw new _.ServerConnection.NetworkError(e)}let a=await n.text();if(a.length>0)try{a=JSON.parse(a)}catch(e){console.log("Not a JSON response body.",n)}if(!n.ok)throw new _.ServerConnection.ResponseError(n,a.message||a);return a}(this._format,this._contentType,this._path);const e=null!==this._session.sessionId?{sessionId:this._session.sessionId}:void 0;this._yWebsocketProvider=new h.WebsocketProvider(this._serverUrl,`${this._session.format}:${this._session.type}:${this._session.fileId}`,this._sharedModel.ydoc,{disableBc:!0,params:e,awareness:this._awareness}),this._yWebsocketProvider.on("sync",this._onSync),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed),this._yWebsocketProvider.messageHandlers[o.ROOM]=(e,s,t,o,i)=>{const r=n.yg(s),a=n.kf(s);this._handleRoomMessage(r,a)}}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}_handleRoomMessage(e,s){switch(e){case i.FILE_CHANGED:this._handleFileChanged(s);break;case i.DOC_OVERWRITTEN:case i.FILE_OVERWRITTEN:this._dialog&&(this._dialog.close(),this._dialog=null);break;case i.SESSION_TOKEN:this._handleSessionToken(s)}}_handleFileChanged(e){this._dialog=new l.Dialog({title:this._trans.__("File changed"),body:this._trans.__("Do you want to overwrite the file or reload it?"),buttons:[l.Dialog.okButton({label:"Reload"}),l.Dialog.warnButton({label:"Overwrite"})],hasClose:!1}),this._dialog.launch().then((s=>{"Reload"===s.button.label?this._sendReloadMsg(e):"Overwrite"===s.button.label&&this._sendOverwriteMsg(e)}))}_handleSessionToken(e){if(this._yWebsocketProvider&&this._session){const s=`${this._session.format}:${this._session.type}:${this._session.fileId}`,t=p.b({sessionId:e});this._yWebsocketProvider.url=this._serverUrl+"/"+s+"?"+t}}_sendReloadMsg(e){var s;const t=a.Mf();a.uE(t,o.ROOM),a.uE(t,i.RELOAD),a.uw(t,e),null===(s=this._yWebsocketProvider)||void 0===s||s.ws.send(a._f(t))}_sendOverwriteMsg(e){var s;const t=a.Mf();a.uE(t,o.ROOM),a.uE(t,i.OVERWRITE),a.uw(t,e),null===(s=this._yWebsocketProvider)||void 0===s||s.ws.send(a._f(t))}}const g="true"===d.PageConfig.getOption("disableRTC");class v extends _.Drive{constructor(e,s){super({name:"RTC"}),this._onCreate=(e,s)=>{if("string"==typeof e.format)try{const t=new y({url:d.URLExt.join(this.serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:s,user:this._user,translator:this._trans}),o=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(o,t),s.disposed.connect((()=>{const e=this._providers.get(o);e&&(e.dispose(),this._providers.delete(o))}))}catch(s){console.error(`Failed to open websocket connection for ${e.path}.\n:${s}`)}},this._user=e,this._trans=s,this._providers=new Map,this.sharedModelFactory=new f(this._onCreate)}dispose(){this.isDisposed||(this._providers.forEach((e=>e.dispose())),this._providers.clear(),super.dispose())}async get(e,s){if(s&&s.format&&s.type){const t=`${s.format}:${s.type}:${e}`,o=this._providers.get(t);if(o){const[t]=await Promise.all([super.get(e,{...s,content:!1}),o.ready]);return t}}return super.get(e,s)}async save(e,s={}){if(s.format&&s.type){const t=`${s.format}:${s.type}:${e}`;if(this._providers.get(t))return this.get(e,{...s,content:!1})}return super.save(e,s)}}class f{constructor(e){this._onCreate=e,this.collaborative=!g,this._documentFactories=new Map}registerDocumentFactory(e,s){if(this._documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this._documentFactories.set(e,s)}createNew(e){if("string"==typeof e.format){if(this.collaborative&&e.collaborative&&this._documentFactories.has(e.contentType)){const s=this._documentFactories.get(e.contentType)(e);return this._onCreate(e,s),s}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}const m=new u.Token("@jupyter/collaboration-extension:ICollaborativeDrive")}}]);