"use strict";(self.webpackChunkjupyterlab_box_drive=self.webpackChunkjupyterlab_box_drive||[]).push([[611],{611:(e,t,a)=>{a.r(t),a.d(t,{default:()=>m});var n=a(543),o=a(777),i=a(322),s=a(257),r=a(497),d=a(957),l=a(840);class c{constructor(){this._isDisposed=!1,this._fileChanged=new l.Signal(this),this._boxAbsPathMap=new Map([["",{id:"0",isdir:!0}],["/",{id:"0",isdir:!0}]]),this._accessToken=""}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,l.Signal.clearData(this))}set accessToken(e){this._accessToken=e}get name(){return"Box"}get serverSettings(){return d.ServerConnection.makeSettings()}get fileChanged(){return this._fileChanged}async get(e,t){if(!(t&&"content"in t&&t.content)&&this._boxAbsPathMap.has(e))return{name:n.PathExt.basename(e),path:e,last_modified:"",created:"",format:null,mimetype:"",content:null,writable:!0,type:this._boxAbsPathMap.get(e).isdir?"directory":"file"};var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0}),o=await this.get_file_id(e);if(t&&"type"in t&&("file"==t.type||"notebook"==t.type))return this.get_file_content(a,o,e,t);var i=a.folders.get({id:o,params:{fields:"name,item_collection"}}),s=await fetch(i.url,{method:i.method,headers:i.headers,mode:i.mode,cache:"no-store"});if(!s.ok&&404==s.status)return this.get_file_content(a,o,e,t);const r=await s.json(),d=[];for(const t of r.item_collection.entries)if("file"==t.type){var l="file";".ipynb"==n.PathExt.extname(t.name)&&(l="notebook"),d.push({name:t.name,path:this.get_abspath_and_set_to_map(e,t.name,t.id,!1),created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:l})}else d.push({name:t.name,path:this.get_abspath_and_set_to_map(e,t.name,t.id,!0),created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:"directory"});return{name:r.name,path:e,last_modified:"",created:"",format:null,mimetype:"",content:d,size:void 0,writable:!0,type:"directory"}}async getDownloadUrl(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e);var n=t.files.getDownloadUrl({id:a}),o=await fetch(n.url,{method:n.method,headers:n.headers,mode:n.mode,cache:"no-store"});const i=await o.json();if(!o.ok)throw new Error;return i.download_url}async newUntitled(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let a="";e&&e.path&&(a=e.path);const o=(null==e?void 0:e.type)||"directory";var i="directory"===o?"Untitled Folder":"untitled";const s=(null==e?void 0:e.ext)||"txt",r=new Date;var d,l;const c="directory"===o;if(c)throw new Error("Method not implemented.");for(let e=0;;e++){const o=`${0==e?`${i}`:`${i} ${e}`}${s}`;d=n.PathExt.join(a,o);let c=n.PathExt.dirname(d);var h=new FormData;h.append("parent_id",await this.get_file_id(c));const m=await this.upload_file_content(t,o,"",h,r);if(m.ok||409!=m.status){l=(await m.json()).entries[0],console.log(l);break}}let m={name:l.name,path:this.get_abspath_and_set_to_map(a,l.name,l.id,c),created:new Date(l.content_created_at).toISOString(),last_modified:new Date(l.content_created_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"};return this._fileChanged.emit({type:"new",oldValue:null,newValue:m}),m}async delete(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e),n=await t.files.delete({id:a});if(!(await fetch(n.url,{method:n.method,headers:n.headers,mode:n.mode,cache:"no-store"})).ok)throw new Error;this.delete_from_map(e)}async rename(e,t){var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const o=await this.get_file_id(e),i=this.get_file_name(t);let s=n.PathExt.dirname(e);const r=await a.files.updateInfo({id:o,name:i});var d=await fetch(r.url,{method:r.method,headers:r.headers,mode:r.mode,body:r.body,cache:"no-store"});const l=await d.json();return this.get_abspath_and_set_to_map(s,i,o,this._boxAbsPathMap.get(e).isdir),{name:i,path:t,created:new Date(l.content_created_at).toISOString(),last_modified:new Date(l.content_modified_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"}}async save(e,t){var a=null==t?void 0:t.format;const o=null==t?void 0:t.content;var i=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let s=n.PathExt.basename(e),r=n.PathExt.dirname(e);var d;"base64"==a?d=await function(e,t="text/plain;charset=UTF-8"){return fetch(`data:${t};base64,`+e).then((e=>e.blob()))}(o):"json"==a?d=JSON.stringify(o,null,2):("text"==a||(a="text"),d=o);var l,c=new FormData;t&&"name"in t?(l=s,c.append("parent_id",await this.get_file_id(r))):(l=this.get_file_name(e),c.append("id",await this.get_file_id(e)));const h=new Date,m=await this.upload_file_content(i,l,d,c,h);console.log(m);const p=await m.json();let _;console.log(p),this._fileChanged.emit({type:"save",oldValue:null,newValue:d});try{var f=await this.get_file_id(e);_=await this.get_file_content(i,f,e,t,h)}catch(t){_={name:l,path:e,created:h.toISOString(),last_modified:h.toISOString(),format:a,mimetype:"",content:null,writable:!0,type:"file"}}return _}async copy(e,t){var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let o=n.PathExt.basename(e),i=n.PathExt.dirname(e);const s=await this.get_file_id(e),r=await this.get_file_id(t),d=n.PathExt.extname(o),l=o.slice(0,o.length-d.length);for(let e=i===t?1:0;;e++){const n=`${0==e?`${l}`:`${l} ${e}`}${d}`,o=await a.files.copy({id:s,name:n,body:{parent:{id:r}}});var c=await fetch(o.url,{method:o.method,headers:o.headers,mode:o.mode,body:o.body,cache:"no-store"});if(!c.ok&&409==c.status)continue;const i=await c.json(),h=this.get_abspath_and_set_to_map(t,n,i.id,!1);return{name:i.name,path:h,last_modified:new Date(i.content_modified_at).toISOString(),created:new Date(i.content_created_at).toISOString(),format:null,mimetype:"",content:"",writable:!0,type:"file"}}}async createCheckpoint(e){return{id:"test",last_modified:(new Date).toISOString()}}async listCheckpoints(e){return[{id:"test",last_modified:(new Date).toISOString()}]}restoreCheckpoint(e,t){return Promise.resolve(void 0)}deleteCheckpoint(e,t){return Promise.resolve(void 0)}async get_file_content(e,t,a,o,i){var s=e.files.get({id:t,params:{fields:["id","name","content_created_at","content_modified_at","extension","item_status","lock","metadata","parent","path_collection","size"].join(",")}}),r=await fetch(s.url,{method:s.method,headers:s.headers,mode:s.mode,cache:"no-store"});const d=await r.json();if(!r.ok)throw new Error;const l=new URL(s.url);var c=[l.protocol,"//",l.host,l.pathname+"/content"].join(""),h=await fetch(c,{method:s.method,headers:s.headers,mode:s.mode,cache:"no-store"});let m,p;m=o&&"type"in o&&o.type?o.type:"file";var _,f,u=h.headers.get("content-type");return null==u?(u="text/plain",p="text"):["ipynb"].includes(d.extension)?(u="",p="json"):["md","yml","yaml","json","py"].includes(d.extension)||["application/x-javascript","image/svg+xml"].includes(u)?(u="text/plain",p="text"):p="application/json"==u?"json":u&&u.split("/")?["text"].includes(u.split("/")[0])?"text":"base64":"text",_="text"==p?await h.text():"notebook"==m.toString()?await h.json():function(e){let t="";const a=new Uint8Array(e);for(let e=0;e<a.byteLength;e++)t+=String.fromCharCode(a[e]);return window.btoa(t)}(await h.arrayBuffer()),f=i?i.toISOString():new Date(d.content_modified_at).toISOString(),{name:d.name,path:n.PathExt.join(a,d.name),created:new Date(d.content_created_at).toISOString(),last_modified:f,format:p,mimetype:u,content:_,writable:!0,type:m}}async upload_file_content(e,t,a,n,o){const i=new File([a],t,{type:"",lastModified:o.getTime()});n.append(t,i);const s=await e.files.upload({body:n});return s.headers&&"Content-Type"in s.headers&&delete s.headers["Content-Type"],await fetch(s.url,{method:s.method,headers:s.headers,body:s.body,mode:s.mode,cache:"no-store"})}async get_file_id(e){var t,a;let o=null===(t=this._boxAbsPathMap.get(e))||void 0===t?void 0:t.id;if(o)return o;let i=n.PathExt.dirname(e);if(!i)return await this.get("",{content:!0}),"0";if(await this.get_file_id(i),await this.get(i,{content:!0}),o=null===(a=this._boxAbsPathMap.get(e))||void 0===a?void 0:a.id,o)return o;throw new Error("ID not found for path")}get_abspath_and_set_to_map(e,t,a,o){const i=n.PathExt.join(e,t);return this._boxAbsPathMap.set(i,{id:a,isdir:o}),i}delete_from_map(e){this._boxAbsPathMap.delete(e)}get_file_name(e){return n.PathExt.basename(e)}}const h=function(){const e=document.currentScript;if(e)return n.URLExt.parse(e.src).pathname+"/../";{const e=document.getElementsByTagName("script"),t=e[e.length-1];return t.src?n.URLExt.parse(t.src).pathname+"/../":"/lab/extensions/jupyterlab-box-drive/static/"}}(),m={id:"jupyterlab-box-drive:plugin",requires:[i.IFileBrowserFactory,s.ITranslator],autoStart:!0,activate:(e,t,a)=>{console.log("JupyterLab extension jupyterlab-box-drive is activated!");const{serviceManager:n}=e,{createFileBrowser:i}=t,s=a.load("jupyterlab-box-drive");!function(e){let t=document.createElement("script");t.setAttribute("src",e),t.setAttribute("type","text/javascript"),document.body.appendChild(t)}(h+"assets/BoxSdk.min.js");const d=new c;n.contents.addDrive(d);const l=i("jp-box-browser",{driveName:d.name,restore:!0});l.title.caption=s.__("Box"),l.title.icon=r.treeViewIcon;const m=new o.ToolbarButton({icon:r.launchIcon,onClick:async()=>{w=window.open(h+"assets/auth.html","BoxAuth","width=600,height=600")},tooltip:s.__("Box | Login"),label:s.__("Box | Login")});l.toolbar.insertItem(0,"get-token",m),m.removeClass("jp-Toolbar-item"),m.addClass("jp-Toolbar-item-BoxDrive");const p=new o.ToolbarButton({icon:r.pasteIcon,onClick:async()=>{g&&navigator.clipboard&&navigator.clipboard.writeText(JSON.stringify({oauth:{client_id:f,client_secret:u,access_token:b}})).then((()=>{(0,o.showDialog)({title:"Copied OAuth2 info to clipboard"})}),(()=>{alert("The Clipboard API is not available")}))},tooltip:s.__("Copy OAuth2 info to clipboard")});l.toolbar.insertItem(1,"get-json",p),e.shell.add(l,"left");var _,f,u,w=null,g="",b="",y=0;const x=async function(){var e=new FormData;e.append("client_id",f),e.append("client_secret",u),e.append("grant_type","refresh_token"),e.append("refresh_token",g);var t=await fetch(_,{method:"POST",body:e});const a=await t.json();if(!t.ok)throw new Error(a);g=a.refresh_token,y=(new Date).getTime()+1e3*a.expires_in,b=a.access_token,d.accessToken=b},v=async function(){try{w&&w.RefreshToken?(_=w.TokenEndpoint,f=w.ClientID,u=w.ClientSecret,g=w.RefreshToken,await x(),w.close(),w=null):g&&y>0&&(new Date).getTime()+6e5>y&&await x()}catch(e){console.error(e)}setTimeout(v,3e3)};v()}}}}]);